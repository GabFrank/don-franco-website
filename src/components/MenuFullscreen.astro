---
import { getMenuPageImageUrl } from "../lib/drive";

interface MenuPage {
  fileId?: string;
  url?: string;
  alt: string;
}

interface Props {
  pages: MenuPage[];
}

const { pages } = Astro.props;
const validPages = pages
  .map((p) => ({ ...p, src: getMenuPageImageUrl(p) }))
  .filter((p) => p.src !== "");
const FALLBACK = "/fallback/menu-placeholder.svg";
---
<div id="menu-viewer" class="menu-viewer" role="dialog" aria-modal="true" aria-label="Menú completo" hidden>
  <button type="button" class="menu-viewer-close" aria-label="Cerrar menú">
    <span aria-hidden="true">&times;</span>
  </button>
  <div class="menu-viewer-scroll">
    {validPages.length > 0 ? (
      validPages.map((p) => (
        <img
          src={p.src}
          alt={p.alt}
          loading="lazy"
          referrerpolicy="no-referrer"
          class="menu-viewer-img"
          onerror={`this.onerror=null;this.src='${FALLBACK}'`}
        />
      ))
    ) : (
      <p class="menu-viewer-empty">Agregá <code>fileId</code> o <code>url</code> (enlace completo de Drive) de cada imagen en <code>content/menu-pages.json</code>.</p>
    )}
  </div>
</div>

<script>
  (function () {
    const viewer = document.getElementById("menu-viewer");
    const closeBtn = viewer?.querySelector(".menu-viewer-close");
    function openViewer() {
      if (!viewer) return;
      viewer.removeAttribute("hidden");
      viewer.classList.add("menu-viewer--open");
      document.body.style.overflow = "hidden";
      closeBtn?.focus();
    }
    function closeViewer() {
      if (!viewer) return;
      viewer.setAttribute("hidden", "");
      viewer.classList.remove("menu-viewer--open");
      document.body.style.overflow = "";
    }
    document.querySelectorAll("[data-open-menu-viewer]").forEach(function (el) {
      el.addEventListener("click", function (e) {
        e.preventDefault();
        openViewer();
      });
    });
    closeBtn?.addEventListener("click", closeViewer);
    viewer?.addEventListener("keydown", function (e) {
      if (e.key === "Escape") closeViewer();
    });
  })();
</script>

<style>
  .menu-viewer {
    position: fixed;
    inset: 0;
    z-index: 200;
    background: var(--color-bg);
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
  }
  .menu-viewer--open {
    opacity: 1;
    visibility: visible;
  }
  .menu-viewer-close {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    z-index: 1;
    width: var(--touch-target-min);
    height: var(--touch-target-min);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text);
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
  }
  .menu-viewer-close:hover {
    background: var(--color-accent);
    color: var(--color-bg);
    border-color: var(--color-accent);
  }
  .menu-viewer-close:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
  .menu-viewer-scroll {
    flex: 1;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    padding: 0;
    margin: 0;
  }
  .menu-viewer-img {
    display: block;
    width: 100%;
    max-width: 900px;
    height: auto;
    margin: 0 auto;
    padding: 0;
    vertical-align: bottom;
    object-fit: contain;
    background: var(--color-surface);
  }
  .menu-viewer-empty {
    padding: var(--space-8);
    color: var(--color-muted);
    max-width: 36rem;
    margin: 0 auto;
  }
  .menu-viewer-empty code {
    background: var(--color-surface);
    padding: 0.125em 0.375em;
    border-radius: 2px;
  }
</style>
