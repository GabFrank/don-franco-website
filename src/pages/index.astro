---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Hero from "../components/Hero.astro";
import MenuFullscreen from "../components/MenuFullscreen.astro";
import StorySection from "../components/StorySection.astro";
import GallerySection from "../components/GallerySection.astro";
import ReviewsSection from "../components/ReviewsSection.astro";
import ContactSection from "../components/ContactSection.astro";
import MapSection from "../components/MapSection.astro";
import Footer from "../components/Footer.astro";
import WhatsAppFloat from "../components/WhatsAppFloat.astro";
import { fetchDriveFolderImages, getMenuPageImageUrl } from "../lib/drive";
import { fetchPlaceRating } from "../lib/places";

let menuPages: Array<{ fileId?: string; url?: string; alt: string }> = [];
let siteConfig: Record<string, unknown> = {};
try {
  const data = await import("../../content/menu-pages.json");
  menuPages = data.default?.pages ?? [];
} catch {
  // no menu-pages.json
}
try {
  const data = await import("../../content/site.json");
  siteConfig = (data.default ?? {}) as Record<string, unknown>;
} catch {
  // no site.json
}

const hero = (siteConfig.hero ?? {}) as Record<string, unknown>;
const heroCarouselFolder =
  (typeof hero.carouselFolderUrl === "string" && hero.carouselFolderUrl.trim() !== "" ? hero.carouselFolderUrl : undefined) ??
  (typeof hero.carouselFolderId === "string" && hero.carouselFolderId.trim() !== "" ? hero.carouselFolderId : undefined);
const heroCarouselLimit = typeof hero.carouselLimit === "number" ? hero.carouselLimit : 10;
const driveApiKey = (import.meta.env.GDRIVE_API_KEY as string | undefined) ?? (import.meta.env.GOOGLE_DRIVE_API_KEY as string | undefined);
const heroCarouselImages = await fetchDriveFolderImages({
  apiKey: driveApiKey,
  folder: heroCarouselFolder,
  limit: heroCarouselLimit,
});
const heroBackgroundFromFolder = heroCarouselImages.map((img) => img.url);
const heroBackgroundRaw = hero.backgroundImages;
const heroBackgroundFromConfig: string[] = Array.isArray(heroBackgroundRaw)
  ? heroBackgroundRaw
      .filter((u): u is string => typeof u === "string")
      .map((url) => getMenuPageImageUrl({ url }) || url)
      .filter((src) => src !== "")
  : [];
const heroBackgroundImages = heroBackgroundFromFolder.length > 0 ? heroBackgroundFromFolder : heroBackgroundFromConfig;

const story = (siteConfig.story ?? {}) as Record<string, unknown>;
const galleryStatic = (siteConfig.gallery ?? {}) as Record<string, unknown>;
const gallery = galleryStatic as Record<string, string>;
const galleryImagesFromConfig = Array.isArray(galleryStatic.images)
  ? (galleryStatic.images as Array<{ url: string; alt: string; link?: string }>)
  : [];

const driveFolderRef =
  (typeof galleryStatic.folderUrl === "string" && galleryStatic.folderUrl.trim() !== "" ? galleryStatic.folderUrl : undefined) ??
  (typeof galleryStatic.folderId === "string" && galleryStatic.folderId.trim() !== "" ? galleryStatic.folderId : undefined);
const driveLimit = typeof galleryStatic.limit === "number" ? galleryStatic.limit : 12;
const driveGalleryImages = await fetchDriveFolderImages({
  apiKey: driveApiKey,
  folder: driveFolderRef,
  limit: driveLimit,
});
const galleryImages = driveGalleryImages.length > 0 ? driveGalleryImages : galleryImagesFromConfig;

const reviewsStatic = (siteConfig.reviews ?? {}) as Record<string, unknown>;
const reviewsPlaceId = typeof reviewsStatic.placeId === "string" && reviewsStatic.placeId.trim() !== "" ? reviewsStatic.placeId.trim() : undefined;
const placesApiKey = (import.meta.env.PLACES_API_KEY as string | undefined) ?? (import.meta.env.GOOGLE_PLACES_API_KEY as string | undefined);
const placeRating = await fetchPlaceRating(placesApiKey, reviewsPlaceId);
const reviews = {
  ...reviewsStatic,
  rating: typeof placeRating.rating === "number" ? placeRating.rating : (reviewsStatic.rating as number) ?? 4.8,
  reviewCount: typeof placeRating.user_ratings_total === "number" ? placeRating.user_ratings_total : (reviewsStatic.reviewCount as number) ?? 120,
} as Record<string, unknown>;
const contact = (siteConfig.contact ?? {}) as Record<string, string>;
const mapConfig = (siteConfig.map ?? {}) as Record<string, string>;
const footer = (siteConfig.footer ?? {}) as Record<string, string>;
const siteName = (siteConfig.siteName as string) ?? "Don Franco";
const metaDescription = (siteConfig.metaDescription as string) ?? "Parrilla artesanal. Men√∫, historia, contacto y reservas.";
---

<BaseLayout title={`${siteName} | Restaurante Artesanal`} description={metaDescription}>
  <Header />
  <main>
    <Hero title={hero.title as string} tagline={hero.tagline as string} description={hero.description as string} ctaText={hero.ctaText as string} backgroundImages={heroBackgroundImages} backgroundImageDuration={typeof hero.backgroundImageDuration === "number" ? hero.backgroundImageDuration : 5} />
    <MenuFullscreen pages={menuPages} />
    <StorySection title={story.title as string} paragraphs={story.paragraphs as string[]} />
    <GallerySection title={gallery.title} intro={gallery.intro} emptyMessage={gallery.emptyMessage} images={galleryImages} />
    <ReviewsSection title={reviews.title as string} rating={reviews.rating as number} reviewCount={reviews.reviewCount as number} linkText={reviews.linkText as string} mapsUrl={reviews.mapsUrl as string} />
    <ContactSection title={contact.title} reservasLabel={contact.reservasLabel} reservarCta={contact.reservarCta} phoneLabel={contact.phoneLabel} phone={contact.phone} whatsapp={contact.whatsapp} addressLabel={contact.addressLabel} address={contact.address} hoursLabel={contact.hoursLabel} hours={contact.hours} />
    <MapSection title={mapConfig.title} embedUrl={mapConfig.embedUrl} fallbackLink={mapConfig.fallbackLink} />
    <Footer siteName={siteName} tagline={footer.tagline} mapsUrl={footer.mapsUrl} instagramUrl={footer.instagramUrl} facebookUrl={footer.facebookUrl} legalText={footer.legalText} />
    <WhatsAppFloat whatsappNumber={contact.whatsapp ?? ""} label="Chatear por WhatsApp con Don Franco" />
  </main>
</BaseLayout>
